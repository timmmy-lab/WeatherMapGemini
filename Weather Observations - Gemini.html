<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="900">
    <title>Australia - Live Weather Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 650px; width: 100%; border-radius: 0.5rem; }
        .weather-popup b { color: #1e40af; font-size: 1.1rem; }
        .weather-popup p { margin: 0.2rem 0; }
        .legend {
            padding: 10px;
            font: 14px/16px Arial, sans-serif;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            line-height: 24px;
            color: #333;
        }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.9; border-radius: 50%; border: 1px solid #fff; }
        .temp-label {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            font-weight: 800;
            font-size: 11px;
            color: white !important;
            text-shadow: 0px 0px 3px rgba(0,0,0,0.8);
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #1e40af;
        }
        .wind-arrow {
            display: inline-block;
            transition: transform 0.5s ease;
            vertical-align: middle;
        }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-8 flex flex-col min-h-screen">
    <div class="max-w-7xl mx-auto flex-grow w-full">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <h1 id="map-title" class="text-3xl font-bold text-slate-800">Australia Live Weather</h1>
                <p id="collection-time" class="text-slate-600 italic">Updating current conditions...</p>
            </div>
            
            <div class="flex items-center gap-2 bg-white p-2 rounded-lg shadow-sm border border-slate-200">
                <label for="region-select" class="text-sm font-semibold text-slate-700 ml-1">Select Region:</label>
                <select id="region-select" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 block p-2">
                    <option value="ALL">All Australia</option>
                    <option value="CAPITALS">Major Cities</option>
                    <optgroup label="States & Territories">
                        <option value="NSW">New South Wales</option>
                        <option value="VIC" selected>Victoria</option>
                        <option value="QLD">Queensland</option>
                        <option value="WA">Western Australia</option>
                        <option value="SA">South Australia</option>
                        <option value="TAS">Tasmania</option>
                        <option value="NT">Northern Territory</option>
                        <option value="ACT">ACT</option>
                    </optgroup>
                </select>
            </div>
        </header>

        <div class="relative bg-white p-2 rounded-xl shadow-lg border border-slate-200 overflow-hidden">
            <div id="loading" class="loading-overlay text-lg">Fetching Live Data...</div>
            <div id="map"></div>
        </div>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm mb-8">
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                <h3 class="font-semibold text-blue-800 mb-1">Live Conditions</h3>
                <p class="text-blue-700">Markers show real-time temperatures. Popups show current wind speed and direction.</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                <h3 class="font-semibold text-green-800 mb-1">Dynamic Bounding Box</h3>
                <p class="text-green-700">The map automatically zooms to the selected region with a protective buffer.</p>
            </div>
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                <h3 class="font-semibold text-slate-800 mb-1">Data Updates</h3>
                <p class="text-slate-700">Weather data is fetched directly from Open-Meteo using real-time models.</p>
            </div>
        </div>

        <footer class="mt-auto pt-8 border-t border-slate-200 text-slate-500 text-xs flex flex-col md:flex-row justify-between items-center gap-4 pb-4">
            <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span><strong>Data Source:</strong> Weather data provided by <a href="https://open-meteo.com/" target="_blank" class="text-blue-600 hover:underline">Open-Meteo</a>.</span>
            </div>
        </footer>
    </div>

    <script>
        const REGIONS = {
            ALL: { name: "Australia" },
            CAPITALS: { name: "Major Cities" },
            NSW: { name: "New South Wales" },
            VIC: { name: "Victoria" },
            QLD: { name: "Queensland" },
            WA: { name: "Western Australia" },
            SA: { name: "South Australia" },
            TAS: { name: "Tasmania" },
            NT: { name: "Northern Territory" },
            ACT: { name: "ACT" }
        };

        const DATA_POINTS = {
            VIC: [
                { name: "Melbourne", lat: -37.8136, lon: 144.9631 },
                { name: "Mildura", lat: -34.1847, lon: 142.1483 }, 
                { name: "Mallacoota", lat: -37.5500, lon: 149.7500 }, 
                { name: "Portland", lat: -38.3460, lon: 141.6030 }, 
                { name: "Wodonga", lat: -36.1214, lon: 146.8872 }, 
                { name: "Bendigo", lat: -36.7570, lon: 144.2794 }, 
                { name: "Horsham", lat: -36.7089, lon: 142.2030 }, 
                { name: "Bairnsdale", lat: -37.8280, lon: 147.6250 }, 
                { name: "Echuca", lat: -36.1360, lon: 144.7470 }, 
                { name: "Warrnambool", lat: -38.3833, lon: 142.4835 }, 
                { name: "Swan Hill", lat: -35.3333, lon: 143.5500 }, 
                { name: "Omeo", lat: -37.0950, lon: 147.5950 }, 
                { name: "Geelong", lat: -38.1499, lon: 144.3617 }, 
                { name: "Ballarat", lat: -37.5622, lon: 143.8503 }, 
                { name: "Shepparton", lat: -36.3833, lon: 145.4236 } 
            ],
            NSW: [
                { name: "Sydney", lat: -33.8688, lon: 151.2093 },
                { name: "Broken Hill", lat: -31.9539, lon: 141.4539 }, 
                { name: "Tweed Heads", lat: -28.1833, lon: 153.5333 }, 
                { name: "Eden", lat: -37.0627, lon: 149.9044 }, 
                { name: "Bourke", lat: -30.0906, lon: 145.9378 }, 
                { name: "Tibooburra", lat: -29.4333, lon: 142.0167 }, 
                { name: "Tamworth", lat: -31.0927, lon: 150.9320 }, 
                { name: "Wagga Wagga", lat: -35.1150, lon: 147.3678 }, 
                { name: "Dubbo", lat: -32.2432, lon: 148.6021 }, 
                { name: "Coffs Harbour", lat: -30.2963, lon: 153.1141 }, 
                { name: "Albury", lat: -36.0737, lon: 146.9135 }, 
                { name: "Wilcannia", lat: -31.5583, lon: 143.3778 }, 
                { name: "Narrabri", lat: -30.3250, lon: 149.7833 }, 
                { name: "Cooma", lat: -36.2350, lon: 149.1250 }, 
                { name: "Newcastle", lat: -32.9283, lon: 151.7817 } 
            ],
            QLD: [
                { name: "Brisbane", lat: -27.4698, lon: 153.0251 },
                { name: "Cairns", lat: -16.9186, lon: 145.7710 }, 
                { name: "Mount Isa", lat: -20.7256, lon: 139.4927 }, 
                { name: "Cunnamulla", lat: -28.0667, lon: 145.6833 }, 
                { name: "Weipa", lat: -12.6469, lon: 141.8767 }, 
                { name: "Townsville", lat: -19.2590, lon: 146.8169 }, 
                { name: "Rockhampton", lat: -23.3774, lon: 150.5100 }, 
                { name: "Longreach", lat: -23.4411, lon: 144.2494 }, 
                { name: "Mackay", lat: -21.1411, lon: 149.1858 }, 
                { name: "Roma", lat: -26.5731, lon: 148.7875 },
                { name: "Birdsville", lat: -25.8988, lon: 139.3514 },
                { name: "Bundaberg", lat: -24.8661, lon: 152.3489 },
                { name: "Toowoomba", lat: -27.5598, lon: 151.9507 },
                { name: "Gladstone", lat: -23.8427, lon: 151.2593 },
                { name: "Charleville", lat: -26.4422, lon: 146.2428 }
            ],
            WA: [
                { name: "Perth", lat: -31.9505, lon: 115.8605 },
                { name: "Wyndham", lat: -15.4825, lon: 128.1228 }, 
                { name: "Eucla", lat: -31.6778, lon: 128.8833 }, 
                { name: "Albany", lat: -35.0228, lon: 117.8814 }, 
                { name: "Exmouth", lat: -21.9314, lon: 114.1236 }, 
                { name: "Kununurra", lat: -15.7736, lon: 128.7389 }, 
                { name: "Broome", lat: -17.9614, lon: 122.2359 }, 
                { name: "Port Hedland", lat: -20.3107, lon: 118.6011 }, 
                { name: "Newman", lat: -23.3539, lon: 119.7319 }, 
                { name: "Kalgoorlie", lat: -30.7489, lon: 121.4658 }, 
                { name: "Esperance", lat: -33.8614, lon: 121.8914 },
                { name: "Geraldton", lat: -28.7744, lon: 114.6089 },
                { name: "Carnarvon", lat: -24.8877, lon: 113.6621 },
                { name: "Meekatharra", lat: -26.5932, lon: 118.4984 },
                { name: "Bunbury", lat: -33.3271, lon: 115.6369 }
            ],
            SA: [
                { name: "Adelaide", lat: -34.9285, lon: 138.6007 },
                { name: "Oodnadatta", lat: -27.5469, lon: 135.4461 }, 
                { name: "Mount Gambier", lat: -37.8284, lon: 140.7804 }, 
                { name: "Ceduna", lat: -32.1250, lon: 133.6733 }, 
                { name: "Marla", lat: -27.1594, lon: 133.6219 }, 
                { name: "Renmark", lat: -34.1667, lon: 140.7500 }, 
                { name: "Port Lincoln", lat: -34.7333, lon: 135.8667 }, 
                { name: "Coober Pedy", lat: -29.0139, lon: 134.7544 },
                { name: "Port Augusta", lat: -32.4931, lon: 137.7625 },
                { name: "Whyalla", lat: -33.0333, lon: 137.5833 },
                { name: "Victor Harbor", lat: -35.5500, lon: 138.6167 },
                { name: "Naracoorte", lat: -36.9542, lon: 140.7431 },
                { name: "Tarcoola", lat: -30.7042, lon: 134.5619 },
                { name: "Roxby Downs", lat: -30.5630, lon: 136.8770 },
                { name: "Border Town", lat: -36.3167, lon: 140.7667 }
            ],
            TAS: [
                { name: "Hobart", lat: -42.8821, lon: 147.3272 },
                { name: "Smithton", lat: -40.8436, lon: 145.1206 }, 
                { name: "St Helens", lat: -41.3219, lon: 148.2472 }, 
                { name: "Queenstown", lat: -42.0833, lon: 145.5500 }, 
                { name: "Launceston", lat: -41.4332, lon: 147.1441 },
                { name: "Burnie", lat: -41.0558, lon: 145.9081 },
                { name: "Devonport", lat: -41.1771, lon: 146.3452 },
                { name: "Strahan", lat: -42.1500, lon: 145.3333 },
                { name: "Geeveston", lat: -43.1667, lon: 146.9167 },
                { name: "Swansea", lat: -42.1220, lon: 148.0750 },
                { name: "Currie (King Is)", lat: -39.9311, lon: 143.8508 },
                { name: "Whitemark (Flinders Is)", lat: -40.1200, lon: 148.0167 },
                { name: "New Norfolk", lat: -42.7828, lon: 147.0594 },
                { name: "Ross", lat: -42.0309, lon: 147.4934 },
                { name: "Scottsdale", lat: -41.1583, lon: 147.5147 }
            ],
            NT: [
                { name: "Darwin", lat: -12.4634, lon: 130.8456 },
                { name: "Alice Springs", lat: -23.6980, lon: 133.8807 },
                { name: "Katherine", lat: -14.4652, lon: 132.2635 },
                { name: "Tennant Creek", lat: -19.6433, lon: 134.1901 },
                { name: "Nhulunbuy", lat: -12.1833, lon: 136.7833 },
                { name: "Yulara (Uluru)", lat: -25.2425, lon: 130.9889 },
                { name: "Jabiru", lat: -12.6681, lon: 132.8361 },
                { name: "Alyangula", lat: -13.8475, lon: 136.4192 },
                { name: "Elliott", lat: -17.5539, lon: 133.5383 },
                { name: "Timber Creek", lat: -15.6461, lon: 130.4756 },
                { name: "Borroloola", lat: -16.0667, lon: 136.3000 },
                { name: "Lajamanu", lat: -18.3333, lon: 132.8333 },
                { name: "Kaltukatjara", lat: -25.0244, lon: 129.2319 },
                { name: "Tiwi Islands", lat: -11.6667, lon: 130.8333 },
                { name: "Mataranka", lat: -14.9239, lon: 133.0675 }
            ],
            ACT: [
                { name: "Canberra City", lat: -35.2809, lon: 149.1300 },
                { name: "Tuggeranong", lat: -35.4167, lon: 149.0667 },
                { name: "Gungahlin", lat: -35.1833, lon: 149.1333 },
                { name: "Belconnen", lat: -35.2389, lon: 149.0661 },
                { name: "Woden Valley", lat: -35.3456, lon: 149.0856 },
                { name: "Hall", lat: -35.1683, lon: 149.0683 },
                { name: "Tharwa", lat: -35.5083, lon: 149.0667 },
                { name: "Oaks Estate", lat: -35.3444, lon: 149.2319 },
                { name: "Uriarra Village", lat: -35.2467, lon: 148.9481 },
                { name: "Molonglo Valley", lat: -35.2917, lon: 149.0333 },
                { name: "Weston Creek", lat: -35.3411, lon: 149.0531 },
                { name: "Dickson", lat: -35.2503, lon: 149.1367 },
                { name: "Fyshwick", lat: -35.3283, lon: 149.1683 },
                { name: "Hume", lat: -35.3850, lon: 149.1617 },
                { name: "Nicholls", lat: -35.1894, lon: 149.0911 }
            ]
        };

        // Populate ALL and CAPITALS after all states are defined
        DATA_POINTS.CAPITALS = [
            DATA_POINTS.NSW[0], DATA_POINTS.VIC[0], DATA_POINTS.QLD[0], 
            DATA_POINTS.WA[0], DATA_POINTS.SA[0], DATA_POINTS.TAS[0], 
            DATA_POINTS.NT[0], DATA_POINTS.ACT[0]
        ];

        DATA_POINTS.ALL = [
            ...DATA_POINTS.CAPITALS,
            DATA_POINTS.NSW[1], DATA_POINTS.VIC[1], DATA_POINTS.QLD[1], 
            DATA_POINTS.WA[1], DATA_POINTS.SA[1], DATA_POINTS.NT[1],
            DATA_POINTS.TAS[1], DATA_POINTS.QLD[2], DATA_POINTS.WA[2]
        ];

        const weatherCodes = {
            0: "Clear Sky", 1: "Mainly Clear", 2: "Partly Cloudy", 3: "Overcast",
            45: "Fog", 48: "Depositing Rime Fog", 51: "Light Drizzle", 61: "Slight Rain",
            71: "Slight Snow", 80: "Slight Rain Showers", 95: "Thunderstorm"
        };

        function getWeatherDesc(code) { return weatherCodes[code] || "Variable Conditions"; }
        function getColor(t) { return t > 30 ? "#ef4444" : t > 25 ? "#f59e0b" : t > 20 ? "#10b981" : "#3b82f6"; }
        
        function getWindDirection(deg) {
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(deg / 45) % 8;
            return directions[index];
        }

        let map, markersLayer;

        function initMap() {
            map = L.map('map').setView([-25.27, 133.77], 4);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO',
                maxZoom: 20
            }).addTo(map);

            markersLayer = L.layerGroup().addTo(map);
            
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function () {
                const div = L.DomUtil.create('div', 'legend');
                const grades = [31, 26, 21, 0];
                const labels = ["> 30°C", "26-30°C", "21-25°C", "< 21°C"];
                div.innerHTML = '<h4 class="font-bold mb-1 text-slate-700 text-xs uppercase text-center">Temp</h4>';
                for (let i = 0; i < grades.length; i++) {
                    div.innerHTML += '<div class="flex items-center mb-1"><i style="background:' + getColor(grades[i]) + '"></i> ' + labels[i] + '</div>';
                }
                return div;
            };
            legend.addTo(map);

            document.getElementById('region-select').addEventListener('change', (e) => {
                updateView(e.target.value);
            });
        }

        function zoomToBuffer(points) {
            if (!points || points.length === 0 || !map) return;
            let minLat = null, maxLat = null, minLon = null, maxLon = null;
            points.forEach(p => {
                const lat = parseFloat(p.lat);
                const lon = parseFloat(p.lon);
                if (isNaN(lat) || isNaN(lon)) return;
                
                if (minLat === null || lat < minLat) minLat = lat;
                if (maxLat === null || lat > maxLat) maxLat = lat;
                if (minLon === null || lon < minLon) minLon = lon;
                if (maxLon === null || lon > maxLon) maxLon = lon;
            });
            
            if (minLat === null || maxLat === null || minLon === null || maxLon === null) return;
            
            const buffer = 0.55; // Slightly larger buffer for better visualization
            try {
                const bounds = L.latLngBounds([minLat - buffer, minLon - buffer], [maxLat + buffer, maxLon + buffer]);
                if (bounds.isValid()) {
                    map.flyToBounds(bounds, { padding: [20, 20], duration: 1.5 });
                }
            } catch (e) { console.warn("Boundary error:", e); }
        }

        async function updateView(regionKey) {
            const region = REGIONS[regionKey];
            const towns = DATA_POINTS[regionKey];
            if (!region || !towns || !map) return;

            document.getElementById('loading').style.display = 'flex';
            document.getElementById('map-title').textContent = `${region.name} Live Weather`;
            markersLayer.clearLayers();
            zoomToBuffer(towns);

            try {
                const validTowns = towns.filter(t => !isNaN(parseFloat(t.lat)) && !isNaN(parseFloat(t.lon)));
                if (validTowns.length === 0) throw new Error("No valid coordinates for region");

                // Split requests if towns > 20 to avoid API limits if necessary, though 15 is fine.
                const lats = validTowns.map(t => t.lat).join(',');
                const lons = validTowns.map(t => t.lon).join(',');
                
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lats}&longitude=${lons}&current=temperature_2m,weather_code,wind_speed_10m,wind_direction_10m&daily=temperature_2m_max&timezone=Australia%2FSydney&forecast_days=1`;

                const response = await fetch(url);
                const data = await response.json();
                const results = Array.isArray(data) ? data : [data];
                
                results.forEach((res, index) => {
                    const town = validTowns[index];
                    if (!town || !res.current) return;

                    const current = res.current;
                    const temp = Math.round(current.temperature_2m);
                    const windSpd = Math.round(current.wind_speed_10m);
                    const windDeg = current.wind_direction_10m;
                    const windCard = getWindDirection(windDeg);
                    const todayMax = res.daily?.temperature_2m_max?.[0];
                    const maxDisplay = todayMax !== undefined ? Math.round(todayMax) + '°C' : 'N/A';
                    
                    const googleWeatherUrl = `https://www.google.com/search?q=weather+${encodeURIComponent(town.name + ', ' + regionKey + ', Australia')}`;

                    const marker = L.circleMarker([town.lat, town.lon], {
                        radius: 14,
                        fillColor: getColor(temp),
                        color: "#fff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    });

                    marker.bindPopup(`
                        <div class="weather-popup" style="min-width: 200px;">
                            <b>${town.name}</b><hr class="my-1">
                            <div class="grid grid-cols-2 gap-2 text-sm mb-2">
                                <div>
                                    <span class="text-gray-500 text-xs font-semibold">TEMP</span><br>
                                    <strong class="text-lg">${temp}°C</strong>
                                </div>
                                <div>
                                    <span class="text-gray-500 text-xs font-semibold">TODAY MAX</span><br>
                                    <span class="text-orange-600 font-bold text-lg">${maxDisplay}</span>
                                </div>
                            </div>
                            <p class="text-xs mb-1"><strong>Condition:</strong> ${getWeatherDesc(current.weather_code)}</p>
                            <div class="bg-slate-50 p-2 rounded border border-slate-100 mb-2">
                                <span class="text-gray-500 text-[10px] font-bold uppercase block mb-1">Wind</span>
                                <div class="flex items-center gap-3">
                                    <div class="flex flex-col">
                                        <span class="text-xs font-bold text-slate-700">${windSpd} <span class="text-[10px] font-normal">km/h</span></span>
                                    </div>
                                    <div class="flex items-center gap-1 border-l pl-3 border-slate-200">
                                        <div class="wind-arrow" style="transform: rotate(${windDeg}deg)">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#1e40af" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="12" y1="19" x2="12" y2="5"></line>
                                                <polyline points="5 12 12 5 19 12"></polyline>
                                            </svg>
                                        </div>
                                        <span class="text-xs font-bold text-blue-800">${windCard}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="pt-2 border-t border-slate-100 text-center">
                                <a href="${googleWeatherUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs font-semibold flex items-center justify-center gap-1">
                                    <span>View Details</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                    </svg>
                                </a>
                            </div>
                        </div>
                    `);

                    marker.bindTooltip(`${temp}`, {
                        permanent: true,
                        direction: 'center',
                        className: 'temp-label'
                    });

                    markersLayer.addLayer(marker);
                });

                document.getElementById('loading').style.display = 'none';
                updateTimestamp();
            } catch (err) {
                console.error("Failed to fetch weather:", err);
                document.getElementById('loading').textContent = "Connection Error.";
            }
        }

        function updateTimestamp() {
            const timeEl = document.getElementById('collection-time');
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('en-AU', {
                timeZone: 'Australia/Sydney',
                dateStyle: 'medium',
                timeStyle: 'short',
                hour12: true
            });
            timeEl.textContent = `Live data updated at ${formatter.format(now)}`;
        }

        window.onload = function() {
            initMap();
            setTimeout(() => { 
                if (map) updateView('VIC'); 
            }, 100);
            
            setInterval(() => {
                const select = document.getElementById('region-select');
                if (select && map) {
                    updateView(select.value);
                }
            }, 900000);
        };
    </script>
</body>
</html>